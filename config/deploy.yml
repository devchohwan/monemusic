# Name of your application. Used to uniquely configure containers.
service: monemusicpractice

# Name of the container image.
image: devchohwan/monemusic

# Deploy to these servers.
servers:
  web:
    - 115.68.195.125  # EC2 인스턴스의 Public IP 입력

# Enable SSL auto certification via Let's Encrypt and allow for multiple apps on a single web server.
# Remove this section when using multiple web servers and ensure you terminate SSL at your load balancer.
#
# Note: If using Cloudflare, set encryption mode in SSL/TLS setting to "Full" to enable CF-to-app encryption.
# proxy 섹션을 주석 처리하여 IP로 직접 접속 가능
# proxy:
#   ssl: false  # 처음에는 false로 설정, 나중에 도메인 설정 후 true로 변경
#   # host: your-domain.com  # 도메인이 있으면 설정

# Credentials for your image host.
registry:
  # Docker Hub 사용시
  # server: docker.io
  username: amuguona
  
  # Always use an access token rather than real password when possible.
  password:
    - KAMAL_REGISTRY_PASSWORD

# Inject ENV variables into containers (secrets come from .kamal/secrets).
env:
  secret:
    - RAILS_MASTER_KEY
    - SECRET_KEY_BASE
  clear:
    # Rails 환경 설정
    RAILS_ENV: production
    RAILS_SERVE_STATIC_FILES: true
    RAILS_LOG_TO_STDOUT: true
    
    # 데이터베이스 설정 (SQLite 사용)
    DATABASE_URL: sqlite3:storage/production.sqlite3

# Aliases are triggered with "bin/kamal <alias>". You can overwrite arguments on invocation:
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole"

# Use a persistent storage volume for sqlite database files and local Active Storage files.
# Recommended to change this to a mounted volume path that is backed up off server.
volumes:
  - "monemusicpractice_storage:/rails/storage"

# Bridge fingerprinted assets, like JS and CSS, between versions to avoid
# hitting 404 on in-flight requests. Combines all files from new and old
# version inside the asset_path.
asset_path: /rails/public/assets

# Configure the image builder.
builder:
  arch: amd64
  dockerfile: Dockerfile.production

# SSH 설정 (EC2 기본 사용자)
ssh:
  user: root